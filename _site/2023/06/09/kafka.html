<!DOCTYPE html><html lang="en" ><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="Jekyll v3.9.3" /><meta property="og:title" content="Kafka" /><meta property="og:locale" content="en_US" /><meta name="description" content="Kafka" /><meta property="og:description" content="Kafka" /><link rel="canonical" href="http://localhost:4000/2023/06/09/kafka" /><meta property="og:url" content="http://localhost:4000/2023/06/09/kafka" /><meta property="og:site_name" content="Kaustubh Deokar" /><meta property="og:image" content="http://localhost:4000/assets/img/consumer-group.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-06-09T00:00:00+05:30" /><meta name="twitter:card" content="summary" /><meta property="twitter:image" content="http://localhost:4000/assets/img/consumer-group.png" /><meta property="twitter:title" content="Kafka" /><meta name="twitter:site" content="@" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-06-09T00:00:00+05:30","datePublished":"2023-06-09T00:00:00+05:30","description":"Kafka","headline":"Kafka","image":"http://localhost:4000/assets/img/consumer-group.png","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2023/06/09/kafka"},"url":"http://localhost:4000/2023/06/09/kafka"}</script><title> Kafka - Kaustubh Deokar</title><link rel="shortcut icon" href="/favicon.png"><link rel="alternate" type="application/atom+xml" title="Kaustubh Deokar" href="/atom.xml"><link rel="alternate" type="application/json" title="Kaustubh Deokar" href="http://localhost:4000/feed.json" /><link rel="sitemap" type="application/xml" title="sitemap" href="/sitemap.xml" /><style> *,:after,:before{box-sizing:border-box;background-color:inherit;color:inherit;margin:0;padding:0}body{font-family:'Ubuntu Mono', monospace;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;line-height:1.5;font-size:1rem;color:#16171a}nav ul{border-right:1px solid #edf2f7}a{color:#000;text-decoration-skip-ink:auto;text-decoration:underline}pre{margin:.5rem 0;padding:.5rem}.post p{margin:.5rem 0}.post h1,.post h2,.post h3,.post h4{margin:1rem 0}.post h2:first-child,.project h2:first-child,.photo h2:first-child{margin-top:0}.meta{margin:2rem 0}code,pre{background:#ecedee}code{padding:.1rem}pre code{border:none}pre{padding:1rem;overflow-x:auto}img{max-width:100%}hr{background:#000;height:1px;border:0}header{flex-basis:10rem;flex-grow:1;position:relative}header a{text-decoration:none}header li{margin-bottom:.2rem;text-align:right;margin-right:2rem}header a.active{font-weight:bold}header,section{padding:1rem}blockquote{font-style:italic;border-left:5px solid #ececec;padding-left:1rem}h1,h2,h3,h4,h5{line-height:1;margin:1rem 0;font-weight:600}section h1:first-child{margin-top:0}strong,b{font-weight:bold}.photos ul{list-style:none}.photos li{margin-bottom:1.5rem}.photo picture,.project picture{margin-bottom:0.5rem}.posts ul,header ul{list-style:none}.posts li{align-items:center;display:flex;justify-content:space-between;margin-bottom:.5rem}.posts li a,.posts li div,.projects li a{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-decoration:none}.posts li time,.projects li time{padding-left:1rem;white-space:nowrap;font-variant-numeric:tabular-nums}main{display:flex;flex-wrap:wrap;max-width:60rem;margin:2rem auto;padding:1rem}@media screen and (max-width: 45rem){header li{display:inline;margin-right:1rem}.logo{padding-bottom:1rem}header ul{border-bottom:1px solid #edf2f7;padding-bottom:2rem}nav ul{border-right:0px}.photos ul{margin-top:0.5rem}}section{flex-basis:0;flex-grow:999;min-width:70%;display:flex;flex-direction:column}figcaption{font-size:smaller}</style></head><body><main role="main"><header role="banner"> <!--<h1 class="logo">Kaustubh Deokar</h1>--><nav role="navigation"><ul><li><a href="/myblog/" >Summary</a></li><li><a href="/myblog/blog/" >Blog</a></li><li><a href="/myblog/category" >Category</a></li><li><a href="/myblog/resume/" >Resume</a></li><li><a href="/myblog/project/" >Project</a></li></ul></nav></header><section class="post"><h2>Kafka</h2><h1 id="kafka">Kafka</h1><p>Kafka is an events, message streaming platform.</p><h3 id="messages">Messages</h3><p>Each message each treated as a byte array. max message size: max.message.bytes = 1MB, batching possible. Message key:value -&gt; key need not be unique, used for partitioning. (Also, key is optional) Each message is timestamped. Each message is stored in topic.</p><h3 id="topics">Topics</h3><ul><li>holds messages, (topic used to store similar message, identical structure).</li><li>multiple topics supported in per kafka instance.</li><li>supports multiple producers and consumers.</li><li>supports multiple partitions. Each message is stored in only one partition.</li></ul><h3 id="broker">Broker</h3><ul><li>Kafka broker is the central piece between the producer and consumers.</li><li>it is a running kafka instance, process executing on the OS.</li><li>brokers controller everything, listening, receiving messages &amp; stores.</li><li>subscription management. Keep a heartbeat with every consumer.</li><li>manage topics, partitions and logs. Takes care of replication of topics across multiple brokers.</li></ul><p>Multiple kafka brokers form a kafka cluster - any one broker will act as the active controller for the broker. Each partition will have a specific broker as the leader.</p><h3 id="logs">Logs</h3><ul><li>managed by kafka brokers.</li><li>files are generated according to broker, topic, partition.</li></ul><h3 id="producers">Producers</h3><ul><li>Takes care of key identification/generation.</li><li>Serialization to bytes upon an agreed contract with the consumer.</li><li>Synchronous and asynchronous publishing options to the broker.</li></ul><h3 id="consumers">Consumers</h3><ul><li>consumers can consume at a later point of time also(streaming/batch)</li><li>multiple concurrent consumers per topic.</li></ul><blockquote><p>Topic creation:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  /kafka-topics.sh --bootstrap-server localhost:29092 --create --topic &lt;name&gt; --partitions 1 --replication-factor 1
</code></pre></div></div></blockquote><blockquote><p>Topic description</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  ./kafka-topics.sh \ --bootstrap-server localhost:29092 \ --list
</code></pre></div></div><p>Producer ``` ./kafka-console-producer.sh \ –bootstrap-server localhost:29092 \ –topic kafka.learning.tweets</p></blockquote><ul><li><p>bootstrap-server &lt;String: server to REQUIRED unless –broker-list <br /> connect to&gt; (deprecated) is specified. The server (s) to connect to. The broker list <br /> string in the form HOST1:PORT1,HOST2: PORT2.</p></li><li><p>topic &lt;String: topic&gt; REQUIRED: The topic id to produce <br /> messages to.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; Consumer
</code></pre></div></div><p>./kafka-console-consumer.sh \ –bootstrap-server localhost:29092 \ –topic kafka.learning.tweets –from-beginning ```</p></li></ul><h3 id="partitions">Partitions</h3><ul><li>Each partition has a leader broker.</li><li>leader takes care of replicating the partition.</li><li>each message goes to only one partition.</li></ul><h3 id="consumer-groups---a-group-of-consumers-who-share-a-topic-workload">Consumer groups - A group of consumers who share a topic workload</h3><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- Each message goes to only one consumer in a group.
- Consumer split the workload through partitions.
- Each consumer groups get all the messages from a topic, but the messages are sent to only one consumer in that consumer group.
</code></pre></div></div><ul><li><img src="/assets/img/consumer-group.png" alt="" /></li></ul><h3 id="consumer-offset-management">Consumer offset management.</h3><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- Number to track message consumption by consumer and partition.
- Current offset: last message sent to a given consumer.
- Committed offset: last message acknowledged by consumer.
- **Resends message on timeout - ensures at least once delivery. (delivery can happen multiple times but will happen atleast once).**
</code></pre></div></div><p>Creating two consumers, belonging to the same consumer group: test-consumer-group, the partitions are split - where the deliver message to only one consumer in the consumer group.</p><ul><li><p><img src="/assets/img/consumer-groups-implementation.png" alt="" /></p></li><li><p>Each consumer group receives all the messages from the topic it is subscribed to</p></li></ul><h2 id="kafka-scaling">Kafka scaling.</h2><h3 id="overview">Overview</h3><p>Resiliency with kafka ?</p><ul><li>Storage failure<ul><li>Replication</li><li>Mirroring - data from one cluster to other cluster.</li></ul></li><li>Broker failure<ul><li>Active controller election</li><li>Topic leader election.</li></ul></li><li>Consumer failure<ul><li>Offset tracking</li><li>Partition reassignments.</li></ul></li></ul><h3 id="kafka-cluster">Kafka Cluster:</h3><ul><li>group of kafka brokers working together.</li><li>each broker has a broker id, each node has a node id.</li></ul><p>Kafka cluster - a group of brokers. - brokers share work based on topic partitions. - metadata - info about clusters, topics and configurations, current status, consumer &amp; consumer groups. - each node(broker) has a copy of the cluster metadata. - nodes in cluster can be either broker, controller or both - only one is the active controller.</p><p>Kafka controller - voting mech to choose the active broker. - active controller writes all metadata to __cluster_metadata topic. - other brokers and controllers read from this topic and update in-memory copies.</p><ul><li><img src="/assets/img/kafka-cluster-controller.png" alt="" /></li></ul><p>Kafka Replication - multiple copies of partition logs are maintained - to avoid broker failures. - unit of replication = partition. - each partition has multiple replicas, set using replication factor. - there is a leader replica and follower replica(s). - leader replica is managed by the leader broker which manages writes reads and storage. - follower replicas are distributed to brokers, which are not leaders for same partition. - replication factors &lt;= no. of brokers.</p><ul><li><img src="/assets/img/replication-in-cluster.png" alt="" /></li></ul><p>Kafka security - producer/consumer/broker auth using ssl/sasl - authorization of read/write operations.</p><p>Kafka cluster setup. - a kafka instance runs three types of ports. - client port is used for external environments, controller port is used for controller communications, internal port is used for communications inside docker environment.</p><ul><li>Kafdrop is used as a monitoring tool.</li></ul><p>Each kafka node can perform two roles: controller &amp; broker.</p><p>Delivery semantics</p><ul><li>At least once<ul><li>Message can be sent multiple times.</li><li>Wait for acknowledgement by the consumer &amp; broker to producer.</li><li>Moderate throughput -</li></ul></li><li>At most once.<ul><li>Acceptable to loose messages.</li><li>Duplicates not acceptable.</li><li>Fire and forget.</li></ul></li><li>Exactly once.<ul><li>How is this achieved in kafka ?</li></ul></li></ul><span class="meta"><time datetime="2023-06-09T00:00:00+05:30">June 9, 2023</time> &middot; </span></section></main></body></html>